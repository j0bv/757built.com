<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hampton Roads Development</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin="" />
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <!-- Gridstack CSS for dashboard layout -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@9.2.5/dist/gridstack.min.css" />
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Adminator CSS for dashboard components -->
    <link rel="stylesheet" href="Adminator-admin-dashboard-master/dist/style.css">
    
    <!-- Calendar Heatmap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.4/dist/cal-heatmap.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="index.css">
    
    <link rel="manifest" href="manifest.webmanifest" />
    
    <style>
        /* App mode transitions */
        .mode-transition {
            transition: all 0.3s ease-in-out;
        }
        
        /* Toggle button styling */
        .mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 20px;
            border-radius: 8px;
            background-color: #2b3b80;
            color: white;
            border: none;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Dashboard grid styling */
        .grid-stack {
            background: #f5f7fa;
        }
        
        .grid-stack-item-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        /* Widget header styling */
        .widget-header {
            padding: 12px 16px;
            background: #eef2f7;
            border-bottom: 1px solid #dce4ec;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Map container */
        #map-container {
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* Globe container */
        #globe {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }
        
        /* Dashboard container */
        #dashboard {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f5f7fa;
            z-index: 10;
            padding-top: 60px;
            overflow: auto;
        }
        
        /* Map is hidden when in dashboard mode */
        .dashboard-mode #map-container {
            display: none;
        }
        
        /* Dashboard is hidden when in map mode */
        .map-mode #dashboard {
            display: none;
        }
        
        /* Node markers styling */
        .map-marker {
            width: 30px !important;
            height: 30px !important;
            position: relative;
            background: transparent !important;
        }
        
        .marker-content {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            color: white;
        }
        
        /* Node popup styling */
        .node-popup {
            padding: 10px;
        }
        
        .node-popup h3 {
            margin: 0 0 10px 0;
            color: #2b3b80;
            font-size: 16px;
            font-weight: 600;
        }
        
        .node-meta {
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .node-actions {
            margin-top: 10px;
        }
        
        /* Mini-map styling */
        #mini-map {
            width: 100%;
            height: 100%;
            min-height: 300px;
        }
        
        /* Calendar heatmap styling */
        #calendar-widget {
            min-height: 300px;
        }
    </style>
</head>
<body class="font-sans bg-background h-screen dashboard-mode" data-theme="dark">
    <!-- Mode toggle button -->
    <button id="modeToggle" class="mode-toggle">
        <i class="fas fa-th"></i>
        <span>Dashboard</span>
    </button>
    
    <!-- Map container - Full screen when in map mode -->
    <div id="map-container" style="display:none;">
        <div id="map"></div>
        <div id="globe"></div>
    </div>
    
    <!-- Dashboard container - Simple fixed layout instead of GridStack -->
    <div id="dashboard" class="fixed inset-0 bg-cyberpunk z-10 overflow-auto pt-16">
        <div class="container mx-auto px-4">
            <h1 class="text-2xl font-bold mb-6 text-neon-blue">Hampton Roads Development Intelligence</h1>
            
            <div class="grid grid-cols-12 gap-6">
                <!-- Calendar Widget -->
                <div class="col-span-4 bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="widget-header">
                        <span>Activity Calendar</span>
                        <button class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <div class="p-4" id="calendar-widget">
                        <div id="cal-heatmap"></div>
                        <div class="flex justify-between items-center mt-3">
                            <button id="prevYear" class="btn btn-sm btn-light"><i class="fas fa-chevron-left"></i></button>
                            <h3 id="currentYear" class="text-lg font-semibold"></h3>
                            <button id="nextYear" class="btn btn-sm btn-light"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>
                
                <!-- Mini Map Widget -->
                <div class="col-span-8 bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="widget-header">
                        <span>Hampton Roads Map</span>
                        <button class="text-gray-500 hover:text-gray-700 fullscreen-toggle" id="mapToggle">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <div class="h-80" id="mini-map">
                        <div id="dashboard-map"></div>
                        <div id="dashboard-globe"></div>
                    </div>
                </div>
                
                <!-- Graph Visualization Widget -->
                <div class="col-span-7 bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="widget-header">
                        <span>Project Lineage Graph</span>
                        <button class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <div class="p-4 h-80" id="git-graph-widget">
                        <div class="text-center text-gray-500 h-full flex flex-col items-center justify-center">
                            <p>Select a project from the map to view its lineage graph</p>
                            <i class="fas fa-project-diagram fa-3x mt-3 text-gray-300"></i>
                        </div>
            </div>
                </div>
                
                <!-- GNN Search Widget -->
                <div class="col-span-5 bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="widget-header">
                        <span>Graph Neural Network</span>
                        <button class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <div class="p-4" id="gnn-widget">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700">Search Type</label>
                            <select class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                <option>Find Similar Projects</option>
                                <option>Research to Projects</option>
                                <option>Patent Connections</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700">Search Input</label>
                            <input type="text" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="Enter project ID, keyword, or locality">
                        </div>
                        <button class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Search Graph
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rotate prompt -->
    <div id="rotatePrompt" style="display:none;position:fixed;inset:0;z-index:1000;background:#000a;color:#fff;align-items:center;justify-content:center;font-size:2rem;text-align:center;">Rotate device to landscape</div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <!-- Lodash (dependency for Gridstack) -->
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    
    <!-- Calendar Heatmap JS -->
    <script src="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.4/dist/cal-heatmap.min.js"></script>
    
    <!-- Globe.gl JS -->
    <script src="https://unpkg.com/globe.gl"></script>
    
    <!-- Main Map JS -->
    <script src="script.js"></script>
    
    <!-- Git Graph Map Integration -->
    <script src="map-integration.js"></script>
    
    <!-- Dashboard initialization and widget management -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // App state
        let isMapMode = true;
        
        // Elements
        const body = document.body;
        const modeToggle = document.getElementById('modeToggle');
        const dashboard = document.getElementById('dashboard');
        const mapContainer = document.getElementById('map-container');
        
        // Debug message
        console.log('Dashboard initialization script running');
        
        // Toggle between map and dashboard modes
        function toggleAppMode() {
            isMapMode = !isMapMode;
            console.log(`Toggling to ${isMapMode ? 'map' : 'dashboard'} mode`);
            
            if (isMapMode) {
                // Switch to map mode
                dashboard.style.display = 'none';
                body.classList.remove('dashboard-mode');
                body.classList.add('map-mode');
                modeToggle.innerHTML = '<i class="fas fa-th"></i> <span>Dashboard</span>';
                
                // Make sure the map is properly sized
                if (window.map) {
                    setTimeout(() => window.map.invalidateSize(), 100);
                }
            } else {
                // Switch to dashboard mode
                dashboard.style.display = 'block';
                body.classList.remove('map-mode');
                body.classList.add('dashboard-mode');
                modeToggle.innerHTML = '<i class="fas fa-map"></i> <span>Map</span>';
                
                // Initialize dashboard components
                initDashboard();
            }
        }
        
        // Initialize the dashboard components
        function initDashboard() {
            console.log('Initializing dashboard');
            
            // Initialize mini map
            setTimeout(initMiniMap, 200);
            
            // Initialize calendar heatmap
            setTimeout(initCalendarHeatmap, 200);
        }
        
        // Initialize the mini map in the dashboard
        function initMiniMap() {
            const miniMapContainer = document.getElementById('mini-map');
            if (!miniMapContainer) {
                console.error('Mini-map container not found');
                return;
            }
            
            console.log('Initializing mini map');
            
            // Create a new map instance for the mini map
            const miniMap = L.map(miniMapContainer, {
                center: [36.9095, -76.2046], // Hampton Roads
                zoom: 9,
                zoomControl: true,
                attributionControl: false
            });
            
            // Add base tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(miniMap);
            
            // Add marker cluster group
            const miniClusterGroup = L.markerClusterGroup();
            miniMap.addLayer(miniClusterGroup);
            
            // Store reference to allow later updates
            window.miniMap = miniMap;
            window.miniClusterGroup = miniClusterGroup;
            
            console.log('Mini map initialized');
            
            // Handle fullscreen toggle
            const fullscreenBtn = miniMapContainer.closest('.widget-header').querySelector('.fullscreen-toggle');
            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', () => {
                    toggleAppMode(); // Switch back to map mode
                });
            }
        }
        
        // Initialize calendar heatmap
        function initCalendarHeatmap() {
            const calendarWidget = document.getElementById('cal-heatmap');
            if (!calendarWidget) {
                console.error('Calendar widget not found');
                return;
            }
            
            console.log('Initializing calendar heatmap');
            
            // Set initial year to current year
            const currentYearEl = document.getElementById('currentYear');
            const prevYearBtn = document.getElementById('prevYear');
            const nextYearBtn = document.getElementById('nextYear');
            
            if (!currentYearEl || !prevYearBtn || !nextYearBtn) {
                console.error('Calendar navigation elements not found');
                return;
            }
            
            let currentYear = new Date().getFullYear();
            currentYearEl.textContent = currentYear;
            
            // Sample data - in a real app, this would come from an API
            const sampleData = {
                2023: {
                    total: 12,
                    contributions: [
                        { date: "2023-01-05", count: 1 },
                        { date: "2023-02-15", count: 2 },
                        { date: "2023-04-10", count: 3 },
                        { date: "2023-06-22", count: 1 },
                        { date: "2023-08-30", count: 2 },
                        { date: "2023-09-15", count: 1 },
                        { date: "2023-10-12", count: 3 },
                        { date: "2023-11-12", count: 3 },
                    ],
                },
                2024: {
                    total: 8,
                    contributions: [
                        { date: "2024-01-20", count: 2 },
                        { date: "2024-03-15", count: 1 },
                        { date: "2024-05-10", count: 3 },
                        { date: "2024-07-05", count: 2 },
                        { date: "2024-08-12", count: 1 },
                        { date: "2024-10-25", count: 2 },
                        { date: "2024-12-01", count: 3 },
                    ],
                }
            };
            
            // Helper function to convert data to Cal-Heatmap format
            function convertToCalHeatmapFormat(year) {
                if (!sampleData[year]) return [];
                
                return sampleData[year].contributions.map(item => ({
                    date: item.date,
                    count: item.count
                }));
            }
            
            // Initialize the calendar
            const cal = new CalHeatmap();
            
            // Function to update the calendar
            function updateCalendar() {
                // Get data for the current year
                const data = convertToCalHeatmapFormat(currentYear);
                
                try {
                    // Paint the calendar with options
                    cal.paint({
                        itemSelector: '#cal-heatmap',
                        domain: {
                            type: 'month',
                            gutter: 0,
                            padding: [15, 0, 0, 0]
                        },
                        subDomain: {
                            type: 'day',
                            radius: 1,
                            width: 10,
                            height: 10,
                            gutter: 2
                        },
                        date: {
                            start: new Date(currentYear, 0, 1),
                            highlight: 'now'
                        },
                        range: 12,
                        scale: {
                            color: {
                                range: ['#161b22', '#0e4429', '#006d32', '#26a641', '#39d353'],
                                type: 'threshold',
                                domain: [1, 2, 3, 5]
                            }
                        },
                        data: {
                            source: data,
                            type: 'json',
                            x: 'date',
                            y: 'count',
                            groupY: 'sum'
                        },
                        tooltip: {
                            text: function(date, value, dayjsDate) {
                                if (!value || value === 0) {
                                    return `No contributions on ${dayjsDate.format('MMMM D, YYYY')}`;
                                }
                                return `${value} contribution${value !== 1 ? 's' : ''} on ${dayjsDate.format('MMMM D, YYYY')}`;
                            }
                        }
                    });
                    console.log('Calendar rendered successfully');
                } catch (error) {
                    console.error('Error rendering calendar:', error);
                }
            }
            
            // Initial calendar render
            updateCalendar();
            
            // Event listeners for navigation
            prevYearBtn.addEventListener('click', function() {
                currentYear--;
                currentYearEl.textContent = currentYear;
                updateCalendar();
            });
            
            nextYearBtn.addEventListener('click', function() {
                currentYear++;
                currentYearEl.textContent = currentYear;
                updateCalendar();
            });
        }
        
        // Event listeners
        modeToggle.addEventListener('click', toggleAppMode);
        console.log('Event listeners added');
        });
    </script>
    
    <!-- Register service worker -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js');
        }
    </script>
    
    <!-- Rotate prompt script -->
    <script>
      function checkOrientation(){
        if(window.matchMedia('(orientation: portrait)').matches){
          document.getElementById('rotatePrompt').style.display='flex';
        } else {
          document.getElementById('rotatePrompt').style.display='none';
        }
      }
      addEventListener('orientationchange',checkOrientation);
      addEventListener('load',checkOrientation);
    </script>
    
    <!-- Load globe module -->
    <script type="module" src="src/dashboard.js"></script>
</body>
</html>